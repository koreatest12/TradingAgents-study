name: CI/CD - Information Server Setup and Deployment (Final)
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  # ====================================================================
  # 1. CI (ì§€ì†ì  í†µí•©) - íŒŒì¼ ê°•ì œ ìƒì„±, ë¹Œë“œ ë° ì•„í‹°íŒ©íŠ¸ ì¤€ë¹„
  # (ê¸°ì¡´ CI_BUILD Jobì€ ìƒëµí•˜ê³ , ë³€ê²½ëœ Jobë§Œ ì•„ë˜ì— ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.)
  # ====================================================================
  ci_build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      # ... (ê¸°ì¡´ CI ë¹Œë“œ ë° ì¤€ë¹„ ìŠ¤í…ë“¤ì€ ì—¬ê¸°ì— ìœ„ì¹˜) ...
      
      - name: ğŸ“¤ ë°°í¬ íŒ¨í‚¤ì§€ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: server-deployment-package
          path: |
            ./artifacts/
            ./spring-boot-app/target/*.jar # JAR íƒ€ê²Ÿ íŒŒì¼ ê²½ë¡œ

  # ====================================================================
  # 2. CD (ì§€ì†ì  ë°°í¬) - ì¸í”„ë¼ ì„¤ì • ë° ìœ íš¨ì„± ê²€ì¦
  # ====================================================================
  cd_deploy:
    needs: ci_build
    runs-on: ubuntu-latest
    steps:
      # ... (ê¸°ì¡´ CD ë°°í¬ ìŠ¤í…ë“¤ì€ ì—¬ê¸°ì— ìœ„ì¹˜) ...
      
      - name: ğŸ’» ì„œë²„ì— íŒŒì¼ ë°°í¬ (ë°°í¬ ê°€ëŠ¥)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          source: "./deploy-package/*"
          target: "/var/www/data-server/"
          
      # ... (ê¸°ì¡´ ê²€ì¦ ìŠ¤í…ë“¤ì€ ì—¬ê¸°ì— ìœ„ì¹˜) ...

  ---

  # ====================================================================
  # 3. Workflows ê´€ë¦¬ - ì‹¤íŒ¨í•œ ì›Œí¬í”Œë¡œìš° ì¸ìŠ¤í„´ìŠ¤ ê°•ì œ ì·¨ì†Œ (ì¶”ê°€ëœ ê¸°ëŠ¥)
  # ====================================================================
  workflow_cleanup:
    name: ğŸ§¹ ì‹¤íŒ¨í•œ ì´ì „ ì›Œí¬í”Œë¡œìš° ê°•ì œ ì¢…ë£Œ/ë¹„í™œì„±í™”
    runs-on: ubuntu-latest
    needs: cd_deploy # ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œëœ í›„ ë˜ëŠ” ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰ ê°€ëŠ¥
    if: always() # ë°°í¬ Jobì˜ ì„±ê³µ/ì‹¤íŒ¨ì™€ ê´€ê³„ì—†ì´ í•­ìƒ ì‹¤í–‰
    
    steps:
      - name: ğŸ›¡ï¸ GitHub CLI ì„¤ì • ë° ì¸ì¦ í™•ì¸
        uses: actions/setup-gh@v1
        with:
          version: 2.x
        
      - name: ğŸ” ì‹¤íŒ¨í•œ ì›Œí¬í”Œë¡œìš° ì°¾ê¸° ë° ì·¨ì†Œ (GitHub CLI ì‚¬ìš©)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # ì·¨ì†Œí•  ì›Œí¬í”Œë¡œìš° ì´ë¦„ (í˜„ì¬ ì›Œí¬í”Œë¡œìš° ì´ë¦„ê³¼ ë™ì¼)
          TARGET_WORKFLOW_NAME: 'CI/CD - Information Server Setup and Deployment (Final)' 
          TARGET_BRANCH: 'main'
          
        run: |
          echo "--- í˜„ì¬ ë¦¬í¬ì§€í† ë¦¬ì˜ ì‹¤íŒ¨í•œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ëª©ë¡ ê²€ìƒ‰ ---"
          
          # 1. ëŒ€ìƒ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ëª©ë¡ì„ 'failure' ìƒíƒœë¡œ í•„í„°ë§í•˜ì—¬ JSONìœ¼ë¡œ ê°€ì ¸ì˜´
          # jqë¥¼ ì‚¬ìš©í•˜ì—¬ 'id'ë§Œ ì¶”ì¶œ
          FAILED_RUN_IDS=$(gh api \
            /repos/${{ github.repository }}/actions/runs \
            -f status=failure \
            -f event=push \
            -f branch=${{ env.TARGET_BRANCH }} \
            --jq '.workflow_runs[] | select(.name == "${{ env.TARGET_WORKFLOW_NAME }}") | .id')

          if [ -z "$FAILED_RUN_IDS" ]; then
            echo "âœ… ì·¨ì†Œí•  'failure' ìƒíƒœì˜ ì´ì „ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
            exit 0
          fi

          echo "âŒ ë‹¤ìŒ ì‹¤íŒ¨í•œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ IDë“¤ì„ ì·¨ì†Œí•©ë‹ˆë‹¤: $FAILED_RUN_IDS"

          # 2. ê° ì‹¤íŒ¨í•œ ì›Œí¬í”Œë¡œìš° IDì— ëŒ€í•´ ê°•ì œ ì·¨ì†Œ API í˜¸ì¶œ (ë¹„í™œì„±í™”)
          for run_id in $FAILED_RUN_IDS; do
            echo "--- ì¸ìŠ¤í„´ìŠ¤ ID: $run_id ê°•ì œ ì·¨ì†Œ ì‹œë„ ì¤‘... ---"
            
            # ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê°•ì œ ì·¨ì†Œ API í˜¸ì¶œ
            CANCEL_RESPONSE=$(gh api \
              --method POST \
              /repos/${{ github.repository }}/actions/runs/$run_id/cancel \
              --silent \
              -H "Accept: application/vnd.github.v3+json")
              
            if [ $? -eq 0 ]; then
              echo "âœ… ID $run_id ì·¨ì†Œ ìš”ì²­ ì„±ê³µ."
            else
              echo "âŒ ID $run_id ì·¨ì†Œ ìš”ì²­ ì‹¤íŒ¨."
            fi
            
          done
          echo "ëª¨ë“  ì‹¤íŒ¨í•œ ì´ì „ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ì— ëŒ€í•œ ê°•ì œ ì¢…ë£Œ/ë¹„í™œì„±í™” ì‘ì—… ì™„ë£Œ."
